{% extends "base.html" %}

{% block title %}Conversation - Indiana University Campus Resource Hub{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 col-xl-8 mx-auto">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('messages.index') }}" class="btn btn-link text-crimson me-3 p-0" style="font-size: 1.25rem;">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div class="d-flex align-items-center">
                    {% if other_user and other_user.profile_image and other_user.profile_image.startswith('profiles/') %}
                        <img src="{{ url_for('auth.uploaded_file', filename=other_user.profile_image.split('/')[-1]) }}?t={{ other_user.profile_image.split('/')[-1].split('.')[0] }}" 
                             alt="{{ other_user.name }}'s profile picture"
                             class="rounded-circle me-3"
                             style="width: 45px; height: 45px; object-fit: cover; border: 2px solid var(--crimson);"
                             onerror="this.style.display='none';">
                    {% endif %}
                    <div>
                        <h4 class="mb-0 fw-semibold" style="color: #333;">
                            {{ other_user.name if other_user else 'User' }}
                        </h4>
                        {% if other_user and other_user.email %}
                        <small class="text-muted">{{ other_user.email }}</small>
                        {% endif %}
                        {% if resource %}
                        <div class="mt-2">
                            <span class="badge bg-secondary">About: {{ resource.title }}</span>
                            <a href="{{ url_for('resources.detail', resource_id=resource.resource_id) }}" class="text-crimson text-decoration-none ms-2">
                                <i class="bi bi-box-arrow-up-right"></i> View Resource
                            </a>
                        </div>
                        {% endif %}
                        {% if messaging_blocked %}
                        <div class="mt-2">
                            <div class="alert alert-warning mb-0 py-2" style="font-size: 0.875rem;">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>This resource has been archived.</strong> No new messages can be sent until the resource is unarchived. You can leave this conversation or delete it.
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="card bg-white border-0 mb-3" style="height: 600px; display: flex; flex-direction: column;">
            <!-- Messages Body -->
            <div class="card-body p-4" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
                {% if messages %}
                    <div class="d-flex flex-column">
                        {% for message in messages %}
                        <div class="mb-3 message-row {% if message.sender_id == current_user.user_id %}message-row-sent{% else %}message-row-received{% endif %}">
                            <div class="message-meta mb-1">
                                {% if message.sender_id != current_user.user_id %}
                                    <small class="text-muted me-2" style="font-size: 0.75rem;">
                                        {{ other_user.name if other_user else 'User' }}
                                    </small>
                                {% endif %}
                                <small class="text-muted" style="font-size: 0.75rem;">
                                    {{ message.timestamp|format_datetime_est('short') }}
                                </small>
                            </div>
                            <div class="message-bubble {% if message.sender_id == current_user.user_id %}message-sent{% else %}message-received{% endif %}">
                                <span class="message-content">{{ message.content|nl2br|safe }}</span>
                            </div>
                            {% if message.booking_id and message.sender_id != current_user.user_id and resource and (resource.owner_id == current_user.user_id or current_user.is_admin()) and booking_statuses.get(message.booking_id) == 'pending' %}
                            <div class="mt-2 d-flex gap-2">
                                <form method="POST" action="{{ url_for('bookings.approve', booking_id=message.booking_id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Are you sure you want to approve this booking request?')">
                                        <i class="bi bi-check-circle me-1"></i>Approve
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('bookings.deny', booking_id=message.booking_id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to deny this booking request?')">
                                        <i class="bi bi-x-circle me-1"></i>Deny
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-5 my-auto">
                        <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-3 mb-0">No messages yet. Start the conversation below!</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Message Input -->
            <div class="card-footer bg-white border-top p-3">
                {% if messaging_blocked %}
                    <div class="alert alert-warning mb-0 py-2" style="font-size: 0.875rem;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Messaging disabled:</strong> This resource has been archived. No new messages can be sent until the resource is unarchived.
                    </div>
                {% else %}
                    <form method="POST" action="{{ url_for('messages.send') }}" id="messageForm">
                        <input type="hidden" name="receiver_id" value="{{ other_user.user_id if other_user else '' }}">
                        <input type="hidden" name="thread_id" value="{{ thread_id }}">
                        {% if resource %}
                            <input type="hidden" name="resource_id" value="{{ resource.resource_id }}">
                        {% endif %}
                        <div class="input-group">
                            <textarea name="content" id="messageContent" class="form-control" 
                                      placeholder="Type your message..." required rows="1" 
                                      style="resize: none; border-radius: 25px; padding: 0.75rem 1.25rem;"
                                      maxlength="2000" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); document.getElementById('messageForm').submit(); }"></textarea>
                            <button type="submit" class="btn btn-crimson rounded-circle" 
                                    style="width: 45px; height: 45px; margin-left: 0.5rem; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block" style="font-size: 0.75rem;">
                            Press Enter to send, Shift+Enter for new line
                        </small>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.message-row {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.message-row-sent {
    align-items: flex-end;
}

.message-row-received {
    align-items: flex-start;
}

.message-meta {
    display: flex;
    align-items: center;
    width: 100%;
    max-width: 70%;
}

.message-row-sent .message-meta {
    justify-content: flex-end;
}

.message-row-received .message-meta {
    justify-content: flex-start;
}

.message-bubble {
    display: table !important;
    table-layout: auto !important;
    max-width: 70% !important;
    width: auto !important;
    min-width: 0 !important;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
    box-sizing: border-box;
    white-space: pre-wrap;
    line-height: 1.5;
}

.message-content {
    display: block;
}

.message-sent {
    background-color: var(--crimson);
    color: white;
    border-bottom-right-radius: 0.25rem !important;
}

.message-received {
    background-color: white;
    color: #333;
    border-bottom-left-radius: 0.25rem !important;
    border: 1px solid #dee2e6;
}

/* Custom Scrollbar */
.card-body::-webkit-scrollbar {
    width: 8px;
}

/* Responsive Message Container */
@media (max-width: 767.98px) {
    .message-bubble {
        max-width: 85% !important;
    }
    .message-meta {
        max-width: 85% !important;
    }
}

.card-body::-webkit-scrollbar-track {
    background: transparent;
}

.card-body::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}

.card-body::-webkit-scrollbar-thumb:hover {
    background: #aaa;
}

/* Auto-resize textarea */
textarea#messageContent {
    min-height: 45px;
    max-height: 120px;
}
</style>

<script>
// Auto-resize textarea
const textarea = document.getElementById('messageContent');
if (textarea) {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Scroll to bottom on load
    window.addEventListener('load', function() {
        const cardBody = document.querySelector('.card-body');
        if (cardBody) {
            cardBody.scrollTop = cardBody.scrollHeight;
        }
    });
}
</script>
{% endblock %}

