<!-- Book This Resource Section -->
<div class="mb-5">
    <h3 class="mb-4 fw-bold" style="color: #333; font-size: 1.5rem;">Book This Resource</h3>
    
    {% if current_user.is_authenticated and resource.status == 'published' %}
        {% if selected_day %}
        <!-- Day View with Time Selection -->
        <div class="bg-white p-4 rounded-3 mb-4" style="box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <!-- Navigation Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h5 class="mb-0 fw-semibold" style="color: #333; font-size: 1.1rem;">
                    <i class="bi bi-calendar3 me-2"></i>{{ day_data.day_name }}, {{ day_data.month }} {{ day_data.day_num }}, {{ day_data.year }}
                </h5>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="window.location.href='{{ url_for('resources.detail', resource_id=resource.resource_id, year=selected_year, month=selected_month) }}'">
                    <i class="bi bi-arrow-left me-1"></i>Back to Calendar
                </button>
            </div>
        </div>
        
        <!-- Time Slots (8 AM - 10 PM, 30-minute intervals) -->
        <div class="day-time-slots" style="border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
            <div class="time-slot-grid" style="display: grid; grid-template-columns: 100px 1fr;">
                <!-- Time Labels Column -->
                <div style="background-color: #f8f9fa; border-right: 2px solid #dee2e6;">
                    {% for slot in day_data.time_slots %}
                    {% if slot.minute == 0 %}
                    <div class="time-label" 
                         style="height: 60px; 
                                border-bottom: 1px solid #dee2e6; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center;
                                font-weight: 600;
                                color: #333;
                                font-size: 0.875rem;"
                         data-time-minutes="{{ slot.time_minutes }}">
                        {% set display_hour = slot.hour if slot.hour <= 12 else slot.hour - 12 %}
                        {% if display_hour == 0 %}{% set display_hour = 12 %}{% endif %}
                        {% set am_pm = "PM" if slot.hour >= 12 else "AM" %}
                        {{ display_hour }}:{{ "%02d"|format(slot.minute) }} {{ am_pm }}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Time Slot Cells -->
                <div class="time-slots-container" style="position: relative;">
                    {% for slot in day_data.time_slots %}
                    <div class="time-slot-cell {% if slot.is_booked %}booked-slot{% elif not slot.is_available %}unavailable-slot{% else %}available-slot{% endif %}" 
                         data-time-minutes="{{ slot.time_minutes }}"
                         data-hour="{{ slot.hour }}"
                         data-minute="{{ slot.minute }}"
                         data-start-time="{{ slot.start_time }}"
                         data-end-time="{{ slot.end_time }}"
                         style="height: 30px; 
                                border-bottom: 1px dashed #dee2e6; 
                                position: relative;
                                cursor: {% if slot.is_available %}pointer{% else %}not-allowed{% endif %};
                                background-color: {% if slot.is_booked %}#fee{% elif not slot.is_available %}#f0f0f0{% else %}#ffffff{% endif %};
                                transition: background-color 0.1s ease;">
                        {% if slot.is_booked and slot.minute == 0 %}
                        <div style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; background-color: #dc3545; color: white; display: flex; align-items: center; padding: 0 8px; font-size: 0.75rem; font-weight: 600;">
                            <i class="bi bi-x-circle me-1"></i>Not Available
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <!-- Selection Overlay -->
                    <div id="time-selection-overlay" class="time-selection-overlay" 
                         style="display: none; 
                                position: absolute; 
                                background-color: rgba(0, 123, 255, 0.4); 
                                border: 2px solid #007bff; 
                                pointer-events: none; 
                                z-index: 10; 
                                border-radius: 4px;">
                    </div>
                    
                    <!-- Current Time Indicator (only for today) -->
                    {% if day_data.is_today and current_time_info %}
                    <div id="current-time-line" 
                         style="position: absolute; 
                                height: 2px; 
                                background-color: #007bff; 
                                z-index: 15; 
                                pointer-events: none;
                                width: 100%;
                                display: none;">
                        <div style="width: 10px; height: 10px; background-color: #007bff; border-radius: 50%; position: absolute; left: -5px; top: -4px; border: 2px solid white; box-shadow: 0 0 0 1px #007bff;"></div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Selection Info -->
        <div id="time-selection-info" class="mt-3 p-3 bg-light rounded" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>Selected Time:</strong> <span id="selected-time-display"></span>
                </div>
                <button type="button" class="btn btn-sm btn-primary" id="use-selection-btn">
                    <i class="bi bi-check-circle me-1"></i>Use This Time
                </button>
            </div>
        </div>
        </div>
        
        <!-- Include Day View JavaScript -->
        {% include 'resources/detail_day_view_js.html' %}
        
        <!-- Booking Form -->
        <div class="bg-white p-4 rounded-3" style="box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <form method="POST" action="{{ url_for('bookings.create') }}" id="bookingForm">
            <input type="hidden" name="resource_id" value="{{ resource.resource_id }}">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="start_datetime" class="form-label fw-semibold" style="color: #333;">Start Time</label>
                    <div class="input-group">
                        <input type="datetime-local" class="form-control" id="start_datetime" name="start_datetime" required style="border-radius: 8px;">
                        <span class="input-group-text bg-white" style="border-left: none; border-radius: 0 8px 8px 0;">
                            <i class="bi bi-calendar3"></i>
                        </span>
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="end_datetime" class="form-label fw-semibold" style="color: #333;">End Time</label>
                    <div class="input-group">
                        <input type="datetime-local" class="form-control" id="end_datetime" name="end_datetime" required style="border-radius: 8px;">
                        <span class="input-group-text bg-white" style="border-left: none; border-radius: 0 8px 8px 0;">
                            <i class="bi bi-calendar3"></i>
                        </span>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <button type="submit" class="btn btn-crimson px-4 py-2" style="font-weight: 500;">
                    <i class="bi bi-calendar-check me-2"></i>Request Booking
                </button>
            </div>
        </form>
        </div>
        {% else %}
        <!-- Month View with Day Selection -->
        <div class="bg-white p-4 rounded-3 mb-4" style="box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <!-- Month Navigation -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h5 class="mb-0 fw-semibold" style="color: #333; font-size: 1.1rem;">
                    <i class="bi bi-calendar3 me-2"></i>{% set month_names = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}{{ month_names[selected_month - 1] }} {{ selected_year }}
                </h5>
            </div>
            <div class="d-flex gap-2">
                {% if can_go_prev %}
                <a href="{{ url_for('resources.detail', resource_id=resource.resource_id, year=prev_year, month=prev_month) }}" 
                   class="btn btn-sm btn-outline-secondary" style="font-weight: 500;">
                    <i class="bi bi-chevron-left me-1"></i>Prev Month
                </a>
                {% endif %}
                {% if selected_year != today.year or selected_month != today.month %}
                <a href="{{ url_for('resources.detail', resource_id=resource.resource_id, year=today.year, month=today.month) }}" 
                   class="btn btn-sm btn-primary" style="font-weight: 500;">
                    <i class="bi bi-calendar-event me-1"></i>Today
                </a>
                {% endif %}
                <a href="{{ url_for('resources.detail', resource_id=resource.resource_id, year=next_year, month=next_month) }}" 
                   class="btn btn-sm btn-outline-secondary" style="font-weight: 500;">
                    Next Month<i class="bi bi-chevron-right ms-1"></i>
                </a>
            </div>
        </div>
        
        <!-- Month Calendar Grid -->
        <div class="month-calendar-grid" style="border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
            <!-- Day Headers -->
            <div class="calendar-weekdays" style="display: grid; grid-template-columns: repeat(7, 1fr); background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                {% for weekday in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                <div class="text-center fw-bold py-2" style="color: #333; font-size: 0.875rem; border-right: 1px solid #dee2e6;">
                    {{ weekday }}
                </div>
                {% endfor %}
            </div>
            
            <!-- Calendar Days -->
            {% for week in calendar_data %}
            <div class="calendar-week" style="display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid #dee2e6;">
                {% for day in week %}
                {% if day %}
                <div class="calendar-day {% if not day.is_selectable %}past-day{% endif %} {% if day.is_today %}today-day{% endif %}" 
                     style="min-height: 80px; 
                            border-right: 1px solid #dee2e6; 
                            padding: 8px;
                            background-color: {% if day.is_today %}#fff3cd{% elif not day.is_selectable %}#f8f9fa{% else %}#ffffff{% endif %};
                            cursor: {% if day.is_selectable %}pointer{% else %}default{% endif %};
                            transition: background-color 0.1s ease;"
                     {% if day.is_selectable %}
                     onclick="window.location.href='{{ url_for('resources.detail', resource_id=resource.resource_id, year=selected_year, month=selected_month, day=day.day) }}'"
                     {% endif %}
                     onmouseover="this.style.backgroundColor='{% if day.is_selectable %}#e7f3ff{% elif day.is_today %}#ffeeba{% else %}#e9ecef{% endif %}'"
                     onmouseout="this.style.backgroundColor='{% if day.is_today %}#fff3cd{% elif not day.is_selectable %}#f8f9fa{% else %}#ffffff{% endif %}'">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <span class="fw-bold" style="color: #333; font-size: 1rem;">{{ day.day }}</span>
                        {% if day.is_today %}
                        <span class="badge bg-primary" style="font-size: 0.65rem;">Today</span>
                        {% endif %}
                    </div>
                    {% if day.has_bookings %}
                    <div class="mt-1">
                        <small class="text-muted" style="font-size: 0.75rem;">
                            <i class="bi bi-calendar-x me-1"></i>{{ day.bookings_count }} booking{{ 's' if day.bookings_count != 1 else '' }}
                        </small>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div style="min-height: 80px; border-right: 1px solid #dee2e6; background-color: #f8f9fa;"></div>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>Click on a date to select a time slot for booking
            </small>
        </div>
        </div>
        {% endif %}
    {% elif not current_user.is_authenticated %}
    <!-- Not authenticated -->
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>Please <a href="{{ url_for('auth.login') }}">log in</a> to book this resource.
    </div>
    {% endif %}
</div>

