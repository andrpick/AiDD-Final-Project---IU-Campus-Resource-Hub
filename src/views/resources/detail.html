{% extends "base.html" %}

{% block title %}{{ resource.title }} - Indiana University Campus Resource Hub{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Resource Title -->
        <h1 class="mb-3 fw-bold" style="font-size: 2.5rem; color: #333; line-height: 1.2;">{{ resource.title }}</h1>
        
        <!-- Resource Details -->
        <div class="d-flex flex-wrap align-items-center gap-3 mb-4" style="font-size: 1rem; color: #333;">
            <span>
                <i class="bi bi-geo-alt-fill text-crimson me-1"></i>{{ resource.location }}
            </span>
            {% if resource.capacity %}
            <span class="text-muted">|</span>
            <span>
                <i class="bi bi-people-fill text-crimson me-1"></i>Capacity: {{ resource.capacity }}
            </span>
            {% endif %}
            <span class="text-muted">|</span>
            <span class="badge bg-crimson px-3 py-2" style="font-size: 0.9rem; font-weight: 500;">
                {{ resource.category|replace('_', ' ')|title }}
            </span>
        </div>

        <!-- Resource Image -->
        {% if resource.images and resource.images|length > 0 %}
        <div class="mb-4">
            {% if resource.images|length > 1 %}
            <div id="imageCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for image in resource.images %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}">
                        <div class="resource-image-container">
                            <img src="{{ url_for('resources.uploaded_file', filename=image) }}" 
                                 class="d-block" 
                                 alt="{{ resource.title }}">
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>
            </div>
            {% else %}
            <div class="resource-image-container">
                <img src="{{ url_for('resources.uploaded_file', filename=resource.images[0]) }}" 
                     class="img-fluid" 
                     alt="{{ resource.title }}">
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Description Section -->
        {% if resource.description %}
        <div class="mb-5">
            <h3 class="mb-3 fw-bold" style="color: #333; font-size: 1.5rem;">Description</h3>
            <p class="mb-0" style="font-size: 1rem; line-height: 1.6; color: #333;">{{ resource.description }}</p>
        </div>
        {% endif %}


        <!-- Status Badge -->
        {% if resource.status == 'draft' %}
        <div class="alert alert-warning mb-4">
            <strong>Status:</strong> This resource is currently a draft and is not visible to other users.
        </div>
        {% endif %}

        <!-- Action Buttons Section -->
        {% if current_user.is_authenticated and resource.owner_id and resource.owner_id != current_user.user_id %}
        <div class="mb-4">
            <a href="{{ url_for('messages.new', receiver_id=resource.owner_id, resource_id=resource.resource_id) }}" class="btn btn-crimson px-4 py-2" style="font-weight: 500;">
                <i class="bi bi-envelope me-2"></i>Message Owner
            </a>
        </div>
        {% endif %}

        <!-- Request Booking Section -->
        {% include 'resources/detail_booking_section.html' %}

        <!-- Reviews Section -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0 fw-bold" style="color: #333; font-size: 1.5rem;">Reviews</h3>
                {% if review_stats and review_stats.avg_rating %}
                <div class="text-end">
                    <div class="h5 mb-0" style="color: #333;">
                        {{ "%.1f"|format(review_stats.avg_rating) }} 
                        <i class="bi bi-star-fill text-warning"></i>
                    </div>
                    <small class="text-muted">{{ total_reviews }} review{{ 's' if total_reviews != 1 else '' }}</small>
                </div>
                {% endif %}
            </div>
            
            {% if reviews and reviews|length > 0 %}
            <!-- Display 3 most recent reviews -->
            <div class="mb-3">
                {% for review in reviews[:3] %}
                <div class="card bg-white mb-3" style="border: 1px solid #dee2e6; border-radius: 8px;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="card-title mb-1 fw-semibold" style="color: #333;">
                                    {{ review.reviewer_name or 'User' }}
                                </h6>
                                <div class="mb-2">
                                    {% for i in range(1, 6) %}
                                    <i class="bi bi-star{% if i <= review.rating %}-fill text-warning{% else %}-empty text-muted{% endif %}" style="font-size: 0.9rem;"></i>
                                    {% endfor %}
                                </div>
                            </div>
                            <small class="text-muted">{{ review.timestamp|format_datetime_est('short') }}</small>
                        </div>
                        {% if review.comment %}
                        <p class="card-text mb-0" style="color: #333; line-height: 1.6;">{{ review.comment }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-2 flex-wrap">
                {% if total_reviews > 3 %}
                <a href="{{ url_for('reviews.resource_reviews', resource_id=resource.resource_id) }}" class="btn btn-outline-secondary px-4 py-2" style="font-weight: 500;">
                    View All Reviews ({{ total_reviews }} total)
                </a>
                {% else %}
                <a href="{{ url_for('reviews.resource_reviews', resource_id=resource.resource_id) }}" class="btn btn-outline-secondary px-4 py-2" style="font-weight: 500;">
                    View All Reviews
                </a>
                {% endif %}
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('reviews.resource_reviews', resource_id=resource.resource_id) }}" class="btn btn-crimson px-4 py-2" style="font-weight: 500;">
                    <i class="bi bi-plus-circle me-1"></i>Add Review
                </a>
                {% endif %}
            </div>
            {% else %}
            <!-- No reviews message -->
            <div class="text-muted mb-3">
                <p class="mb-2">No reviews yet.</p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <a href="{{ url_for('reviews.resource_reviews', resource_id=resource.resource_id) }}" class="btn btn-outline-secondary px-4 py-2" style="font-weight: 500;">
                    View Reviews
                </a>
                {% if current_user.is_authenticated %}
                <a href="{{ url_for('reviews.resource_reviews', resource_id=resource.resource_id) }}" class="btn btn-crimson px-4 py-2" style="font-weight: 500;">
                    <i class="bi bi-plus-circle me-1"></i>Add Review
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarWrapper = document.querySelector('.weekly-calendar-wrapper');
    const calendarCells = document.querySelectorAll('.calendar-cell');
    const selectionOverlay = document.getElementById('selection-overlay');
    const selectionInfo = document.getElementById('selection-info');
    const selectionTimeDisplay = document.getElementById('selection-time-display');
    const confirmSelectionBtn = document.getElementById('confirm-selection-btn');
    const startDateTimeInput = document.getElementById('start_datetime');
    const endDateTimeInput = document.getElementById('end_datetime');
    const currentTimeIndicator = document.getElementById('current-time-indicator');
    
    let isSelecting = false;
    let startCell = null;
    let endCell = null;
    let selectedCells = [];
    
    // Position current time indicator
    if (currentTimeIndicator) {
        const timeMinutes = parseInt(currentTimeIndicator.getAttribute('data-time-minutes'));
        const colIndex = parseInt(currentTimeIndicator.getAttribute('data-col-index'));
        
        // Calculate position
        const headerHeight = 60;
        const cellHeight = 30;
        const timeColumnWidth = 80;
        const totalWidth = 900; // min-width from grid
        const dayColumnWidth = (totalWidth - timeColumnWidth) / 7;
        
        // Calculate row (each hour has 2 rows: :00 and :30)
        // Time is in minutes from midnight, we need minutes from 8 AM
        const minutesFrom8am = timeMinutes - (8 * 60);
        if (minutesFrom8am >= 0 && minutesFrom8am < (14 * 60)) { // Within 8 AM - 10 PM
            const rowIndex = Math.floor(minutesFrom8am / 30);
            const minutesIntoSlot = minutesFrom8am % 30;
            const topPosition = headerHeight + (rowIndex * cellHeight) + (minutesIntoSlot / 30 * cellHeight);
            
            // Calculate left position (time column + day column)
            const leftPosition = timeColumnWidth + (colIndex * dayColumnWidth);
            
            currentTimeIndicator.style.left = leftPosition + 'px';
            currentTimeIndicator.style.width = dayColumnWidth + 'px';
            currentTimeIndicator.style.top = topPosition + 'px';
            currentTimeIndicator.style.display = 'block';
        }
    }
    
    // Helper function to check if cell is available (not booked)
    function isCellAvailable(cell) {
        // Check if cell has booked class or booking block
        return !cell.classList.contains('booked-cell') && !cell.querySelector('.booking-block');
    }
    
    // Helper function to get cell position in grid
    function getCellPosition(cell) {
        const wrapperRect = calendarWrapper.getBoundingClientRect();
        const cellRect = cell.getBoundingClientRect();
        return {
            top: cellRect.top - wrapperRect.top + calendarWrapper.scrollTop,
            left: cellRect.left - wrapperRect.left + calendarWrapper.scrollLeft,
            width: cellRect.width,
            height: cellRect.height,
            date: cell.getAttribute('data-date'),
            timeMinutes: parseInt(cell.getAttribute('data-time-minutes')),
            time: cell.getAttribute('data-time')
        };
    }
    
    // Helper function to get cells between start and end
    function getCellsBetween(startCell, endCell) {
        const startPos = getCellPosition(startCell);
        const endPos = getCellPosition(endCell);
        
        // Must be same day
        if (startPos.date !== endPos.date) {
            return [];
        }
        
        // Find all cells in the selection range
        const cells = [];
        const startMinutes = Math.min(startPos.timeMinutes, endPos.timeMinutes);
        const endMinutes = Math.max(startPos.timeMinutes, endPos.timeMinutes);
        
        calendarCells.forEach(cell => {
            const pos = getCellPosition(cell);
            if (pos.date === startPos.date && 
                pos.timeMinutes >= startMinutes && 
                pos.timeMinutes < endMinutes &&
                isCellAvailable(cell)) {
                cells.push(cell);
            }
        });
        
        return cells;
    }
    
    // Update selection overlay
    function updateSelectionOverlay(startCell, endCell) {
        if (!startCell || !endCell || !isCellAvailable(startCell) || !isCellAvailable(endCell)) {
            selectionOverlay.style.display = 'none';
            selectionInfo.style.display = 'none';
            return;
        }
        
        const startPos = getCellPosition(startCell);
        const endPos = getCellPosition(endCell);
        
        // Must be same day
        if (startPos.date !== endPos.date) {
            selectionOverlay.style.display = 'none';
            selectionInfo.style.display = 'none';
            return;
        }
        
        const startMinutes = Math.min(startPos.timeMinutes, endPos.timeMinutes);
        const endMinutes = Math.max(startPos.timeMinutes, endPos.timeMinutes);
        
        // Find first and last cells
        let firstCell = startCell;
        let lastCell = endCell;
        if (startPos.timeMinutes > endPos.timeMinutes) {
            firstCell = endCell;
            lastCell = startCell;
        }
        
        const firstPos = getCellPosition(firstCell);
        const lastPos = getCellPosition(lastCell);
        
        // Calculate overlay position and size
        const overlayTop = firstPos.top;
        const overlayLeft = firstPos.left;
        const overlayHeight = (lastPos.top + lastPos.height) - firstPos.top;
        const overlayWidth = firstPos.width;
        
        selectionOverlay.style.display = 'block';
        selectionOverlay.style.top = overlayTop + 'px';
        selectionOverlay.style.left = overlayLeft + 'px';
        selectionOverlay.style.width = overlayWidth + 'px';
        selectionOverlay.style.height = overlayHeight + 'px';
        
        // Update selection info
        const duration = endMinutes - startMinutes;
        const hours = Math.floor(duration / 60);
        const minutes = duration % 60;
        
        const startHour24 = Math.floor(startMinutes / 60);
        const startMin = startMinutes % 60;
        const endHour24 = Math.floor(endMinutes / 60);
        const endMin = endMinutes % 60;
        
        // Convert to 12-hour format
        const startHour12 = startHour24 === 0 ? 12 : (startHour24 > 12 ? startHour24 - 12 : startHour24);
        const endHour12 = endHour24 === 0 ? 12 : (endHour24 > 12 ? endHour24 - 12 : endHour24);
        const startAmPm = startHour24 >= 12 ? 'PM' : 'AM';
        const endAmPm = endHour24 >= 12 ? 'PM' : 'AM';
        
        const startTimeStr = `${startHour12}:${startMin.toString().padStart(2, '0')} ${startAmPm}`;
        const endTimeStr = `${endHour12}:${endMin.toString().padStart(2, '0')} ${endAmPm}`;
        
        const dateParts = firstPos.date.split('-');
        const dateStr = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;
        
        selectionTimeDisplay.textContent = `${dateStr} ${startTimeStr} - ${endTimeStr} (${hours}h${minutes > 0 ? ' ' + minutes + 'm' : ''})`;
        selectionInfo.style.display = 'block';
    }
    
    // Mouse events for drag selection
    calendarCells.forEach(cell => {
        cell.addEventListener('mousedown', function(e) {
            if (!isCellAvailable(cell)) return;
            
            isSelecting = true;
            startCell = cell;
            endCell = cell;
            selectedCells = [cell];
            
            updateSelectionOverlay(startCell, endCell);
            
            e.preventDefault();
        });
        
        cell.addEventListener('mouseenter', function() {
            if (isSelecting && isCellAvailable(cell)) {
                endCell = cell;
                selectedCells = getCellsBetween(startCell, endCell);
                updateSelectionOverlay(startCell, endCell);
            }
        });
        
        cell.addEventListener('mouseup', function() {
            if (isSelecting) {
                isSelecting = false;
            }
        });
    });
    
    // Stop selection when mouse leaves calendar
    document.addEventListener('mouseup', function() {
        isSelecting = false;
    });
    
    // Handle month dropdown change
    const monthSelect = document.getElementById('month-select');
    const weekSelect = document.getElementById('week-select');
    
    if (monthSelect) {
        monthSelect.addEventListener('change', function() {
            const selectedMonth = this.value;  // Format: "YYYY-MM"
            const [year, month] = selectedMonth.split('-').map(Number);
            
            // Find the first week that starts in the selected month
            updateWeekDropdownForMonth(year, month);
        });
    }
    
    // Handle week dropdown change
    if (weekSelect) {
        weekSelect.addEventListener('change', function() {
            const selectedWeekOffset = parseInt(this.value);
            // Navigate to selected week
            const url = new URL(window.location.href);
            url.searchParams.set('week', selectedWeekOffset);
            window.location.href = url.toString();
        });
    }
    
    // Update week dropdown based on selected month
    function updateWeekDropdownForMonth(year, month) {
        if (!weekSelect) return;
        
        // Find the first week that starts in the selected month
        let firstWeekInMonth = null;
        {% for week_option in available_weeks %}
        {
            const weekStartDate = new Date('{{ week_option.start_date.isoformat() }}');
            if (weekStartDate.getFullYear() === year && weekStartDate.getMonth() === month - 1) {
                if (!firstWeekInMonth) {
                    firstWeekInMonth = {{ week_option.offset }};
                }
            }
        }
        {% endfor %}
        
        // Navigate to first week in that month, or current week if not found
        const url = new URL(window.location.href);
        url.searchParams.set('week', firstWeekInMonth !== null ? firstWeekInMonth : 0);
        window.location.href = url.toString();
    }
    
    // Confirm selection button
    if (confirmSelectionBtn) {
        confirmSelectionBtn.addEventListener('click', function() {
            if (!startCell || !endCell) return;
            
            const startPos = getCellPosition(startCell);
            const endPos = getCellPosition(endCell);
            
            const startMinutes = Math.min(startPos.timeMinutes, endPos.timeMinutes);
            const endMinutes = Math.max(startPos.timeMinutes, endPos.timeMinutes);
            
            const startHour = Math.floor(startMinutes / 60);
            const startMin = startMinutes % 60;
            const endHour = Math.floor(endMinutes / 60);
            const endMin = endMinutes % 60;
            
            const [year, month, day] = startPos.date.split('-');
            const startTimeStr = `${startHour.toString().padStart(2, '0')}:${startMin.toString().padStart(2, '0')}`;
            const endTimeStr = `${endHour.toString().padStart(2, '0')}:${endMin.toString().padStart(2, '0')}`;
            
            const startDateTime = `${year}-${month}-${day}T${startTimeStr}`;
            const endDateTime = `${year}-${month}-${day}T${endTimeStr}`;
            
            if (startDateTimeInput) {
                startDateTimeInput.value = startDateTime;
            }
            if (endDateTimeInput) {
                endDateTimeInput.value = endDateTime;
            }
            
            // Hide selection info
            selectionOverlay.style.display = 'none';
            selectionInfo.style.display = 'none';
            
            // Scroll to form
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                bookingForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        });
    }
    
    // Validate form on submit
    const bookingForm = document.getElementById('bookingForm');
    if (bookingForm && startDateTimeInput && endDateTimeInput) {
        bookingForm.addEventListener('submit', function(e) {
            const start = new Date(startDateTimeInput.value);
            const end = new Date(endDateTimeInput.value);
            const now = new Date();
            
            // Check if start is at least 1 hour in future
            const minStart = new Date(now.getTime() + 60 * 60 * 1000);
            if (start < minStart) {
                e.preventDefault();
                alert('Booking must be at least 1 hour in the future.');
                return false;
            }
            
            // Check if end is after start
            if (end <= start) {
                e.preventDefault();
                alert('End time must be after start time.');
                return false;
            }
            
            // Check duration (30 minutes to 8 hours)
            const durationMinutes = (end - start) / (1000 * 60);
            if (durationMinutes < 30) {
                e.preventDefault();
                alert('Minimum booking duration is 30 minutes.');
                return false;
            }
            if (durationMinutes > 480) {
                e.preventDefault();
                alert('Maximum booking duration is 8 hours.');
                return false;
            }
            
            return true;
        });
    }
});
</script>
{% endblock %}

